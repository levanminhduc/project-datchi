############################################################
# Đất Chỉ - Docker Compose (FE + BE only)
# Supabase chạy sẵn bằng `supabase start`
#
# Usage:
#   docker compose --env-file .env.docker up --build -d
############################################################

services:
  # ── Frontend (nginx) ──────────────────────────────────
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        VITE_API_URL: ${VITE_API_URL:-}
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:-/supabase}
        VITE_SUPABASE_ANON_KEY: ${ANON_KEY}
    ports:
      - "${FRONTEND_PORT:-8080}:80"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      backend:
        condition: service_started
    restart: unless-stopped

  # ── Backend (Hono API) ────────────────────────────────
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    ports:
      - "${BACKEND_PORT:-3010}:3000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PORT: 3000
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:8080}
      NEXT_PUBLIC_SUPABASE_URL: http://host.docker.internal:54321
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SERVICE_ROLE_KEY}
      SUPABASE_JWT_SECRET: ${JWT_SECRET}
    restart: unless-stopped
