## 2026-01-26 Backend Infrastructure

**Context**: Creating Hono backend with Supabase for employee management
**Pattern**: Use `dotenv.config()` at the start of server files before accessing environment variables
**Reason**: Node.js environment differs from Vite - process.env needs explicit loading via dotenv

---

## 2026-01-26 API Response Structure

**Context**: Implementing CRUD API endpoints
**Pattern**: All API responses use structured format `{ data, error, message }` with Vietnamese error messages
**Reason**: Consistent error handling and i18n support for Vietnamese UI

---

## 2026-01-26 Duplicate Check Before Insert

**Context**: Creating employee with unique employee_code constraint
**Pattern**: Check for existing record with same unique field before insert, return 409 Conflict with specific message
**Reason**: Better UX than relying on database constraint errors - provides clear Vietnamese feedback "Mã nhân viên đã tồn tại"

---

## 2026-01-26 Quasar Notifications

**Context**: Creating Employee Management page with user feedback
**Pattern**: Use `useSnackbar()` composable from `@/composables` instead of direct `$q.notify()` - provides unified API with `success()`, `error()`, `warning()`, `info()` methods
**Reason**: Composables already show notifications on CRUD success/error, so pages should NOT add duplicate notifications. Use snackbar composable for consistency.

---

## 2026-01-26 Responsive Table Columns

**Context**: Responsive employee data table
**Pattern**: Define separate column arrays for mobile/desktop and use `$q.screen.lt.sm` to switch between them
**Reason**: Simpler than CSS-only approach, hides less important columns on mobile for better UX

---

## 2026-01-26 Quasar Virtual Scroll for Large Datasets (DEPRECATED)

**Context**: Implementing virtual scroll for 1630+ employee records
**Pattern**: ~~For q-table with virtual-scroll, MUST set fixed height container~~ **DEPRECATED**: Use pagination instead of virtual scroll for better UX with page size control
**Reason**: Virtual scroll lacks page size selector and traditional pagination controls that users expect

---

## 2026-01-27 Quasar q-table Pagination Mode

**Context**: Switching from virtual-scroll to pagination for employee table
**Pattern**: Use `v-model:pagination` with `rowsPerPage`, `page`, `sortBy`, `descending` properties; watch search/filter changes to reset `page = 1`
**Reason**: Quasar q-table handles pagination automatically when you provide the pagination model and rows-per-page-options

---

## 2026-01-26 Quasar q-popup-edit for Inline Editing

**Context**: Implementing inline cell editing in q-table
**Pattern**: Use `@save="(val, initialVal) => handler()"` callback to get both new and original values; store `originalValue` for rollback on API failure
**Reason**: v-model applies changes immediately (optimistic update), but if API fails you need original value to revert the cell

---

## 2026-01-27 Supabase Batch Fetching for Large Datasets

**Context**: Fetching all 1630+ employees when Supabase enforces max_rows=1000
**Pattern**: Use range-based batch fetching: loop with `.range(offset, offset + BATCH_SIZE - 1)` until `batchData.length < BATCH_SIZE`
**Reason**: Supabase PostgREST limits responses to 1000 rows by default; batch fetching bypasses this without server config changes

---

## 2026-01-27 Vue Reactive Proxy to API Functions

**Context**: Passing `reactive()` form data to API functions that use JSON.stringify
**Pattern**: Always spread reactive objects to plain objects before passing to API: `createEmployee({ ...formData })` not `createEmployee(formData)`
**Reason**: Vue's reactive proxy can cause issues with JSON.stringify; spreading creates a plain object copy

---

## 2026-01-27 Supabase RLS and Service Role Key

**Context**: Backend UPDATE/DELETE operations failing silently due to RLS policies
**Pattern**: Use `supabaseAdmin` (with service_role key) for backend operations; keep `supabase` (anon key) for frontend-like read operations
**Reason**: RLS policies block anon key from modifying data; service_role key bypasses RLS for trusted backend code

---

## 2026-01-27 Quasar $q.notify() Undefined Properties Override Defaults

**Context**: Success notifications showing black instead of green despite type: 'positive'
**Pattern**: Use conditional spread `...(prop && { prop })` when passing optional properties to `$q.notify()` - never pass `undefined` values
**Reason**: Quasar's notify interprets explicit `undefined` as overriding the type's default color; conditional spread only includes defined properties

---

## 2026-01-27 Quasar Icon Format - Material Icons Only

**Context**: Notification icons not rendering in useSnackbar.ts
**Pattern**: Use Material Icons format (`check_circle`, `error`, `warning`, `info`) not MDI format (`mdi-check-circle`)
**Reason**: Project only imports Material Icons CSS (via Quasar extras); MDI icons require separate @mdi/font import which is not included

---

## 2026-01-29 Dynamic Dropdown Options from Database

**Context**: Converting static dropdown options to dynamic database-driven options
**Pattern**: Create a composable (`usePositions`) that fetches data on mount and provides `computed` options (`positionOptions`) and labels mapping (`positionLabels`) for UI components
**Reason**: Static hardcoded options don't scale - database-driven options allow adding/removing items without code changes. Use same pattern as departments (fetched from employees) but with dedicated API endpoint for lookup tables.

---

## 2026-01-29 Spec Organization

**Context**: Organizing specs for better maintainability
**Pattern**: Use `specs/features/` for feature specs, `specs/ui-components/` for component library specs
**Reason**: Clear separation between feature documentation and component documentation; single file per feature reduces navigation overhead

---

## 2026-01-29 Hono Parameterized Route Guards

**Context**: `/api/employees/count` was being matched by `/:id` route instead of `/count` static route
**Pattern**: Add guards in parameterized routes (`/:id`) to check if the id matches known static route names, and validate UUID format before database query
**Reason**: Hono's router can sometimes match parameterized routes before static routes due to caching or timing; guard pattern provides belt-and-suspenders protection

---

## 2026-01-29 PostgreSQL RPC Row-Level Locking Pattern

**Context**: Creating atomic allocation RPC function with FEFO logic to prevent race conditions
**Pattern**: Use `FOR UPDATE SKIP LOCKED` in loops that process inventory rows concurrently; return JSON with success/message fields for consistent error handling
**Reason**: `FOR UPDATE` locks rows for modification, `SKIP LOCKED` prevents deadlocks by skipping already-locked rows. Essential for concurrent allocation scenarios where multiple requests compete for same inventory.
